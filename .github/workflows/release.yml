name: Release
on:
  push:
    branches: [main]

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - name: Install dependencies
        run: pnpm install

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Python dependencies
        run: |
          cd apps/api
          uv sync --dev

      - name: Check for changesets
        id: check-changesets
        run: |
          if [ -n "$(git ls-files .changeset/*.md)" ]; then
            echo "has-changesets=true" >> $GITHUB_OUTPUT
            echo "üìù Found changesets - preparing release"
          else
            echo "has-changesets=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changesets found - skipping release"
          fi

      - name: Update versions
        if: steps.check-changesets.outputs.has-changesets == 'true'
        run: |
          echo "üîß Updating package versions..."
          pnpm version-packages
          echo "‚úÖ Package versions updated"

      - name: Create Release Pull Request
        if: steps.check-changesets.outputs.has-changesets == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: update package versions"
          title: "chore: update package versions"
          body: |
            This PR was created by Changesets to update package versions.

            ## What's included:
            - Updated package versions based on changesets
            - Synchronized Python API version
            - Generated changelog

            ## Next steps:
            1. Review the changes
            2. Merge this PR to create a release
          branch: release/versions
          delete-branch: true

      - name: Create GitHub Release
        if: steps.check-changesets.outputs.has-changesets == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Get current version
          VERSION=$(node -p "require('./package.json').version")

          # Create release
          gh release create "v$VERSION" \
            --title "Release $VERSION" \
            --notes "Release $VERSION - see CHANGELOG.md for details" \
            --latest

          echo "üéâ GitHub release v$VERSION created successfully!"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Release Summary
        if: steps.check-changesets.outputs.has-changesets == 'true'
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "## üéâ Release Prepared!"
          echo "**Version:** $VERSION"
          echo "**Status:** Ready for merge and release"
          echo "**Next:** Merge the version update PR to create the release"
