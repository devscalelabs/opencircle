name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: moonrepo/setup-moon@v1
      - uses: moonrepo/setup-proto@v1
      - name: Install dependencies
        run: moon install
      - name: Lint TypeScript projects
        run: moon run admin:lint platform:lint core-package:lint ui-package:lint --parallel
      - name: Lint Python project
        run: moon run api:lint
      - name: Type check TypeScript projects
        run: moon run admin:typecheck platform:typecheck core-package:typecheck ui-package:typecheck --parallel
      - name: Type check Python project
        run: moon run api:typecheck
      - name: Run tests
        run: moon run api:test --parallel

  build:
    runs-on: ubuntu-latest
    needs: quality
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - uses: actions/checkout@v4
      - uses: moonrepo/setup-moon@v1
      - uses: moonrepo/setup-proto@v1
      - name: Install dependencies
        run: moon install
      - name: Build TypeScript projects
        run: moon run admin:build platform:build core-package:build ui-package:build --parallel
      - name: Build Docker images
        run: docker compose build
